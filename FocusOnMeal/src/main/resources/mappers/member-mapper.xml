<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fom.boot.domain.member.model.mapper.MemberMapper">


  	<select id="selectOneByLogin" parameterType="com.fom.boot.app.member.dto.LoginRequest" resultType="Member">
  		SELECT 
  		MEMBER_ID,
  		MEMBER_PW,
        MEMBER_NAME,
        MEMBER_NICKNAME,
        EMAIL,
        PHONE,
        GENDER,
        ENROLL_DATE,
        STATUS_YN,
        ADMIN_YN
  		FROM MEMBER
  		WHERE MEMBER_ID = #{memberId}
  	</select>
  	
    <!-- Spring Security용 쿼리 -->
    <select id="findByMemberId" parameterType="String"
            resultType="com.fom.boot.domain.member.model.vo.Member">
        SELECT
            MEMBER_ID,
            MEMBER_PW,
            MEMBER_NAME,
            MEMBER_NICKNAME,
            EMAIL,
            PHONE,
            GENDER,
            ENROLL_DATE,
            STATUS_YN,
            ADMIN_YN
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
          AND STATUS_YN = 'Y' 
    </select>
    
    <!-- 회원가입 -->
    <insert id="insertMember" parameterType="Member">
        INSERT INTO MEMBER VALUES(
            #{memberId},
            #{memberPw},
            #{memberName},
            #{memberNickname},
            #{email},
            #{phone},
            #{gender},
            default,
            default,
            default
        )
    </insert>

    <!-- 관리자 권한 부여 및 닉네임 변경 -->
    <update id="updateAdminNickname" parameterType="map">
        UPDATE MEMBER
        SET ADMIN_YN = 'Y',
            MEMBER_NICKNAME = #{newAdminNickname}
        WHERE MEMBER_ID = #{memberId}
    </update>

    <!-- 닉네임 변경 -->
    <update id="updateNickname" parameterType="map">
        UPDATE MEMBER
        SET MEMBER_NICKNAME = #{memberNickname}
        WHERE MEMBER_ID = #{memberId}
    </update>
    
    <!-- 비밀번호 업데이트 (비밀번호 재설정용) -->
	<update id="updateMemberPassword">
	    UPDATE MEMBER
	    SET MEMBER_PW = #{encodedPw}
	    WHERE MEMBER_ID = #{memberId}
	</update>
	
	<!-- 아이디 찾기 (이름과 이메일로 조회) -->
	<select id="searchMemberId" resultType="String">
	    SELECT MEMBER_ID
	    FROM MEMBER
	    WHERE MEMBER_NAME = #{memberName}
	      AND EMAIL = #{email}
	      AND STATUS_YN = 'Y'
	    FETCH FIRST 1 ROW ONLY
	</select>
	
	<!-- 회원 조회 (ID로) -->
	<select id="selectOneById" parameterType="String" resultType="Member">
	    SELECT 
	        MEMBER_ID,
	        MEMBER_PW,
	        MEMBER_NAME,
	        MEMBER_NICKNAME,
	        EMAIL,
	        PHONE,
	        GENDER,
	        ENROLL_DATE,
	        STATUS_YN,
	        ADMIN_YN
	    FROM MEMBER
	    WHERE MEMBER_ID = #{memberId}
	      AND STATUS_YN = 'Y'
	</select>

	 
	<!-- 이메일 중복 확인 -->
	<select id="checkEmailExists" parameterType="String" resultType="int">
	    SELECT COUNT(*)
	    FROM MEMBER
	    WHERE EMAIL = #{email}
	      AND STATUS_YN = 'Y'
	</select>
	 
    <!-- 관리자: 전체 회원 목록 조회 -->
	<select id="selectAllMembers" parameterType="map" resultType="com.fom.boot.domain.member.model.vo.Member">
	    SELECT *
	    FROM (
	        SELECT ROWNUM, A.*
	        FROM (
	            SELECT *
	            FROM MEMBER
                <where>
                    <if test="type == 'all' and keyword != null and keyword != ''">
                        ( MEMBER_ID LIKE '%' || #{keyword} || '%'
                          OR MEMBER_NAME LIKE '%' || #{keyword} || '%'
                          OR MEMBER_NICKNAME LIKE '%' || #{keyword} || '%'
                        )
                    </if>
    
                    <if test="type != 'all' and keyword != null and keyword != ''">
                        <choose>
                            <when test="type == 'memberId'">
                                MEMBER_ID LIKE '%' || #{keyword} || '%'
                            </when>
                            <when test="type == 'memberName'">
                                MEMBER_NAME LIKE '%' || #{keyword} || '%'
                            </when>
                            <when test="type == 'memberNickname'">
                                MEMBER_NICKNAME LIKE '%' || #{keyword} || '%'
                            </when>
                        </choose>
                    </if>
                </where>
	            ORDER BY ENROLL_DATE DESC
	        ) A
	        WHERE ROWNUM &lt;= #{endRow} )
	    WHERE ROWNUM &gt;= #{startRow} 
    </select>

	<!-- 관리자 : 회원 등급 변경 -->
	<update id="updateAdminYn">
	    UPDATE MEMBER
	    SET ADMIN_YN = #{adminYn}
	    WHERE MEMBER_ID = #{memberId}
	</update>
	
	<!-- 관리자 : 회원 상태 변경 -->
	<update id="updateStatusYn">
	    UPDATE MEMBER
	    SET STATUS_YN = #{statusYn}
	    WHERE MEMBER_ID = #{memberId}
	</update>
	
	<!-- 관리자 : 총 회원 수 -->
	<select id="getTotalMembersBySearch" resultType="int">
    SELECT COUNT(*)
        FROM MEMBER
        <where>
            <if test="type == 'all' and keyword != null and keyword != ''">
                ( MEMBER_ID LIKE '%' || #{keyword} || '%'
                  OR MEMBER_NAME LIKE '%' || #{keyword} || '%'
                  OR MEMBER_NICKNAME LIKE '%' || #{keyword} || '%'
                )
            </if>
    
            <if test="type != 'all' and keyword != null and keyword != ''">
                <choose>
                    <when test="type == 'memberId'">
                        MEMBER_ID LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="type == 'memberName'">
                        MEMBER_NAME LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="type == 'memberNickname'">
                        MEMBER_NICKNAME LIKE '%' || #{keyword} || '%'
                    </when>
                </choose>
            </if>
        </where>
    </select>
  </mapper>
