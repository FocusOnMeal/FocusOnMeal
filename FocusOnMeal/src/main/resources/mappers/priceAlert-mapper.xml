<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fom.boot.domain.alert.model.mapper.PriceAlertMapper">

    <select id="selectMySetting" resultType="com.fom.boot.domain.alert.model.vo.PriceAlert">
        SELECT 
            ALERT_ID             AS alertId,
            MEMBER_ID            AS memberId,
            INGREDIENT_ID        AS ingredientId,
            THRESHOLD_PRICE      AS thresholdPrice,
            NOTIFICATION_ENABLED AS notificationEnabled
        FROM PRICE_ALERT_SETTING
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
    </select>

    <insert id="insertPriceAlert" parameterType="com.fom.boot.domain.alert.model.vo.PriceAlert">
        INSERT INTO PRICE_ALERT_SETTING (
            ALERT_ID, 
            MEMBER_ID, 
            INGREDIENT_ID, 
            THRESHOLD_PRICE, 
            NOTIFICATION_ENABLED
        ) VALUES (
            SEQ_PRICE_ALERT_SETTING.NEXTVAL, 
            #{memberId}, 
            #{ingredientId}, 
            #{thresholdPrice}, 
            'Y'
        )
    </insert>

    <update id="updatePriceAlert" parameterType="com.fom.boot.domain.alert.model.vo.PriceAlert">
        UPDATE PRICE_ALERT_SETTING
        SET THRESHOLD_PRICE = #{thresholdPrice},
            NOTIFICATION_ENABLED = 'Y'
        WHERE MEMBER_ID = #{memberId}
          AND INGREDIENT_ID = #{ingredientId}
    </update>

    <select id="selectTargetMemberIds" resultType="string">
        SELECT MEMBER_ID
        FROM PRICE_ALERT_SETTING
        WHERE INGREDIENT_ID = #{ingredientId}
          AND NOTIFICATION_ENABLED = 'Y'
          AND THRESHOLD_PRICE >= #{currentPrice}
    </select>

</mapper>